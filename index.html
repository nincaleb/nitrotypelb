<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NitroType Leaderboards</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            margin: 20px;
            background: #121212;
            color: #fff;
        }
        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        #message, #teamMessage {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        table {
            margin: 0 auto;
            width: 90%;
            border-collapse: collapse;
            background: #1c1c1c;
            border: 1px solid #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        }
        table thead tr {
            background: linear-gradient(45deg, #2c3e50, #34495e);
        }
        table thead th {
            padding: 12px;
            color: #fff;
            text-align: left;
            font-weight: 400;
            border-bottom: 1px solid #fff;
        }
        table tbody tr {
            background: #1c1c1c !important;
        }
        table tbody td {
            padding: 10px;
            font-size: 0.95em;
            border-bottom: 1px solid #fff;
        }
        .car-image {
            height: 40px;
            image-rendering: -webkit-optimize-contrast;
            transition: transform 0.2s;
        }
        .car-image:hover {
            transform: scale(1.8);
            z-index: 100;
        }
        .subtitle {
            color: #888;
            font-size: 0.85em;
            display: block;
            margin-top: 2px;
        }
        #teamLeaderboard_wrapper {
            margin-top: 40px;
        }
        a {
            color: #3498db;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <h1>NitroType Player Leaderboard</h1>
    <div id="message">Loading leaderboard...</div>
    
    <table id="leaderboard" class="display">
        <thead>
            <tr>
                <th>Place</th>
                <th>Racer</th>
                <th>Car</th>
                <th>Points</th>
                <th>Speed (WPM)</th>
                <th>Accuracy (%)</th>
                <th>Races</th>
                <th>Team</th>
            </tr>
        </thead>
    </table>

    <h1 style="margin-top: 50px;">Top Teams</h1>
    <div id="teamMessage">Loading team rankings...</div>
    <table id="teamLeaderboard" class="display">
        <thead>
            <tr>
                <th>Rank</th>
                <th>Team</th>
                <th>Total Points</th>
            </tr>
        </thead>
    </table>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return y + m + d;
        }

        const playerCsv = `nitrotype_season_leaderboard_${formatDate(new Date())}.csv`;
        const teamCsv = `nitrotype_team_leaderboard_${formatDate(new Date())}.csv`;

        Papa.parse(playerCsv, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                const processedData = results.data.map((row, index) => ({
                    rank: index + 1,
                    displayName: row.DisplayName || 'Unknown',
                    profileLink: row.ProfileLink || '#',
                    title: row.Title || 'No Title',
                    carID: row.CarID || 1,
                    hueAngle: row.CarHueAngle || 0,
                    points: parseFloat(row.Points) || 0,
                    speed: Math.round(row.Speed) || 0,
                    accuracy: parseFloat(row.Accuracy).toFixed(2) || 0,
                    races: row.Races || 0,
                    team: row.Team || ''
                })).sort((a, b) => b.points - a.points);

                $('#leaderboard').DataTable({
                    data: processedData,
                    pageLength: 100,
                    order: [[3, 'desc']],
                    columns: [
                        { data: 'rank' },
                        { 
                            data: null,
                            render: (data) => `
                                <a href="${data.profileLink}" target="_blank">${data.displayName}</a>
                                <span class="subtitle">${data.title}</span>
                            `
                        },
                        {
                            data: null,
                            render: (data) => `
                                <img src="https://www.nitrotype.com/cars/${data.carID}_${data.hueAngle}.png" 
                                     class="car-image" 
                                     alt="Car ${data.carID}">
                            `
                        },
                        { data: 'points' },
                        { data: 'speed' },
                        { data: 'accuracy' },
                        { data: 'races' },
                        {
                            data: 'team',
                            render: (team) => team ? `
                                <a href="https://nitrotype.com/team/${team}" target="_blank">${team}</a>
                            ` : ''
                        }
                    ]
                });

                Papa.parse(teamCsv, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: function(teamResults) {
                        const teamData = teamResults.data
                            .filter(t => t.Team && t.TotalPoints)
                            .sort((a, b) => b.TotalPoints - a.TotalPoints)
                            .map((t, i) => ({
                                rank: i + 1,
                                team: t.Team,
                                points: t.TotalPoints
                            }));

                        $('#teamLeaderboard').DataTable({
                            data: teamData,
                            pageLength: 50,
                            order: [[2, 'desc']],
                            columns: [
                                { data: 'rank' },
                                { 
                                    data: 'team',
                                    render: (team) => `
                                        <a href="https://nitrotype.com/team/${team}" target="_blank">${team}</a>
                                    `
                                },
                                { data: 'points' }
                            ]
                        });
                        document.getElementById('teamMessage').textContent = '';
                    },
                    error: function(err) {
                        document.getElementById('teamMessage').textContent = 'Error loading team data: ' + err;
                    }
                });

                document.getElementById('message').textContent = '';
            },
            error: function(err) {
                document.getElementById('message').textContent = 'Error loading player data: ' + err;
            }
        });
    </script>
</body>
</html>